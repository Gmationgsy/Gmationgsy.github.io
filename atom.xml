<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2021-05-31T15:42:49.989Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring Cloud Security 结合 oauth2的基本使用方法</title>
    <link href="http://example.com/2021/05/31/oauth2/"/>
    <id>http://example.com/2021/05/31/oauth2/</id>
    <published>2021-05-31T15:09:16.902Z</published>
    <updated>2021-05-31T15:42:49.989Z</updated>
    
    <content type="html"><![CDATA[<h3 id="oauth2的简介"><a href="#oauth2的简介" class="headerlink" title="oauth2的简介"></a>oauth2的简介</h3><h4 id="简介-：OAuth-2-0是用于授权的行业标准协议。OAuth-2-0为简化客户端开发提供了特定的授权流，包括Web应用、桌面应用、移动端应用等。"><a href="#简介-：OAuth-2-0是用于授权的行业标准协议。OAuth-2-0为简化客户端开发提供了特定的授权流，包括Web应用、桌面应用、移动端应用等。" class="headerlink" title="简介 ：OAuth 2.0是用于授权的行业标准协议。OAuth 2.0为简化客户端开发提供了特定的授权流，包括Web应用、桌面应用、移动端应用等。"></a>简介 ：OAuth 2.0是用于授权的行业标准协议。OAuth 2.0为简化客户端开发提供了特定的授权流，包括Web应用、桌面应用、移动端应用等。</h4><h4 id="OAuth-2-0中的四种模式-：授权码模式-简化模式-密码模式-客户端模式"><a href="#OAuth-2-0中的四种模式-：授权码模式-简化模式-密码模式-客户端模式" class="headerlink" title="OAuth 2.0中的四种模式 ：授权码模式  简化模式  密码模式  客户端模式"></a>OAuth 2.0中的四种模式 ：授权码模式  简化模式  密码模式  客户端模式</h4><h3 id="开启案例-："><a href="#开启案例-：" class="headerlink" title="开启案例 ："></a>开启案例 ：</h3><h4 id="我们采取的是springboot-的工程的搭建-（授权码模式）："><a href="#我们采取的是springboot-的工程的搭建-（授权码模式）：" class="headerlink" title="我们采取的是springboot 的工程的搭建 （授权码模式）："></a>我们采取的是springboot 的工程的搭建 （授权码模式）：</h4><h4 id="1-选择我们需要的模块"><a href="#1-选择我们需要的模块" class="headerlink" title="1.选择我们需要的模块"></a>1.选择我们需要的模块</h4><h5 id><a href="#" class="headerlink" title></a><img src="/2021/05/31/oauth2/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210531211551.png"></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&lt;/dependency</span><br></pre></td></tr></table></figure><h4 id="2-配置application-yml"><a href="#2-配置application-yml" class="headerlink" title="2.配置application.yml"></a>2.配置application.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br></pre></td></tr></table></figure><h4 id="3-首先我们配置SecurityConfig"><a href="#3-首先我们配置SecurityConfig" class="headerlink" title="3.首先我们配置SecurityConfig"></a>3.首先我们配置SecurityConfig</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于对用户名字的密码加密</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.csrf()</span><br><span class="line">                .disable()    <span class="comment">//关闭csrf</span></span><br><span class="line">                .authorizeRequests()  <span class="comment">//开启认证</span></span><br><span class="line">                .anyRequest()     <span class="comment">//任何请求</span></span><br><span class="line">                .authenticated()    <span class="comment">//任何请求都需要认证才可以访问</span></span><br><span class="line">                .and()             </span><br><span class="line">                .formLogin()        <span class="comment">//允许表单登录</span></span><br><span class="line">                .permitAll();        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        auth.inMemoryAuthentication()    <span class="comment">//用来存用户名，这里是基本内存的存法  </span></span><br><span class="line">                .withUser(<span class="string">&quot;admin&quot;</span>)    <span class="comment">//用户名</span></span><br><span class="line">                .password( <span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">&quot;123&quot;</span>)) <span class="comment">//密码</span></span><br><span class="line">                .roles(<span class="string">&quot;user&quot;</span>)   <span class="comment">//角色</span></span><br><span class="line">                .and()           <span class="comment">//配置多个</span></span><br><span class="line">                .withUser(<span class="string">&quot;guo&quot;</span>)   </span><br><span class="line">                .password( <span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">&quot;123&quot;</span>))</span><br><span class="line">                .roles(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h4 id="4配置-授权服务器"><a href="#4配置-授权服务器" class="headerlink" title="4配置 授权服务器"></a>4配置 <strong>授权服务器</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAuthorizationServer</span>   <span class="comment">//开启资源认证</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationServer</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients.inMemory()   <span class="comment">//基于内存</span></span><br><span class="line">                .withClient(<span class="string">&quot;gsy&quot;</span>)<span class="comment">//配置client_id</span></span><br><span class="line">                .secret(passwordEncoder.encode(<span class="string">&quot;gsy123456&quot;</span>))<span class="comment">//配置client_secret</span></span><br><span class="line">                .accessTokenValiditySeconds(<span class="number">7200</span>)<span class="comment">//配置访问token的有效期</span></span><br><span class="line">                .refreshTokenValiditySeconds(<span class="number">25600</span>)<span class="comment">//配置刷新token的有效期</span></span><br><span class="line">                .redirectUris(<span class="string">&quot;http://www.baidu.com&quot;</span>)<span class="comment">//配置redirect_uri，用于授权成功后跳转</span></span><br><span class="line">                .scopes(<span class="string">&quot;all&quot;</span>)<span class="comment">//配置申请的权限范围</span></span><br><span class="line">                .autoApprove(<span class="keyword">true</span>)  <span class="comment">//自动批准</span></span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;authorization_code&quot;</span>);<span class="comment">//配置grant_type，表示授权类型</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4配置-资源服务器"><a href="#4配置-资源服务器" class="headerlink" title="4配置 资源服务器"></a>4配置 资源服务器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        http.authorizeRequests()  </span><br><span class="line">                .anyRequest()     </span><br><span class="line">                .authenticated()    </span><br><span class="line">                .and()</span><br><span class="line">                .requestMatchers()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/**&quot;</span>).and();<span class="comment">//配置需要保护的资源路径</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5配置-测试controller"><a href="#5配置-测试controller" class="headerlink" title="5配置 测试controller"></a>5配置 测试controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/getCurrentUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello1</span><span class="params">(String code, Model model)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="string">&quot;asdaqsdad&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-开启测试-（开启项目）"><a href="#6-开启测试-（开启项目）" class="headerlink" title="6 开启测试   （开启项目）"></a>6 开启测试   （开启项目）</h4><p>首先在浏览器上进行访问  ：<a href="http://localhost:9001/oauth/authorize?response_type=code&amp;client_id=gsy&amp;redirect_uri=http://www.baidu.com&amp;scope=all&amp;state=normal">http://localhost:9001/oauth/authorize?response_type=code&amp;client_id=gsy&amp;redirect_uri=http://www.baidu.com&amp;scope=all&amp;state=normal</a></p><p>分析 ：</p><p><a href="http://localhost:9001/oauth/authorize">http://localhost:9001/oauth/authorize</a>   地址固定</p><p>response_type=code  表示授权码模式 </p><p>client_id，  redirect_uri 的参数   要和  <strong>授权服务器</strong>中的配置的要一样</p><p>访问地址得到 ：</p><p><img src="/2021/05/31/oauth2/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210531221649.png"></p><p>用户名 /密码为 SecurityConfig配置的 admin/123 或者  guo/123  点击提交，会跳转到百度 <strong>redirect_uri</strong>参数控制的。</p><h4 id="-1"><a href="#-1" class="headerlink" title></a><img src="/2021/05/31/oauth2/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210531220719.png"></h4><p>获取code 然后 通过 postman工具 来获取  access_token</p><p><img src="/2021/05/31/oauth2/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210531221010.png"></p><p><img src="/2021/05/31/oauth2/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210531221058.png"></p><p>使用basic认证  填写上  <strong>授权服务器</strong>里面定位用户与密码</p><p>然后使用post 请求  添加一下参数  code参数为浏览器中获取得  code只可以用一次 ，点击请求 </p><p><img src="/2021/05/31/oauth2/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210531222008.png"></p><p>获取到  access_token  就可以去访问  测试controller</p><p><img src="/2021/05/31/oauth2/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210531222227.png"></p><p>配置 access_token  参数 访问  </p><p><img src="/2021/05/31/oauth2/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210531222434.png"></p><p>不配置会报错 </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;error&quot;</span>: <span class="string">&quot;unauthorized&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;error_description&quot;</span>: <span class="string">&quot;Full authentication is required to access this resource&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7-至此一个简单的oauth2的测试已经结束-，下一章更新-第二种模式-（密码模式）认证，已经-refresh-token-的作用"><a href="#7-至此一个简单的oauth2的测试已经结束-，下一章更新-第二种模式-（密码模式）认证，已经-refresh-token-的作用" class="headerlink" title="7.至此一个简单的oauth2的测试已经结束 ，下一章更新  第二种模式 （密码模式）认证，已经  refresh_token 的作用"></a>7.至此一个简单的oauth2的测试已经结束 ，下一章更新  第二种模式 （密码模式）认证，已经  refresh_token 的作用</h4>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;oauth2的简介&quot;&gt;&lt;a href=&quot;#oauth2的简介&quot; class=&quot;headerlink&quot; title=&quot;oauth2的简介&quot;&gt;&lt;/a&gt;oauth2的简介&lt;/h3&gt;&lt;h4 id=&quot;简介-：OAuth-2-0是用于授权的行业标准协议。OAuth-2-0为简</summary>
      
    
    
    
    
  </entry>
  
</feed>
